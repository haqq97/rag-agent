<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Assistant</title>
    <style>
      :root {
        --accent: #026cbd;
        --accent-hover: #025aa3;
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-muted: #999999;
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-tertiary: #f1f3f4;
        --border-color: #e9ecef;
        --border-hover: #dee2e6;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-family);
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.5;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-primary);
        flex-shrink: 0;
      }

      .logo {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        object-fit: cover;
        background: var(--bg-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: var(--accent);
      }

      .logo img {
        width: 100%;
        height: 100%;
        border-radius: var(--radius-sm);
      }

      .header-content h1 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .header-content p {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 0;
        margin-top: 2px;
      }

      /* Suggested Questions */
      .suggested {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
        flex-shrink: 0;
      }

      .suggested h3 {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        padding: 8px 12px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 12px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chip:hover {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      /* Chat Log */
      .chat-log {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: var(--bg-primary);
      }

      .message {
        margin-bottom: 20px;
        animation: fadeIn 0.3s ease;
      }

      .message.user {
        text-align: right;
      }

      .message.assistant {
        text-align: left;
      }

      .message-bubble {
        display: inline-block;
        max-width: 80%;
        padding: 12px 16px;
        border-radius: var(--radius-md);
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;
      }

      .message.user .message-bubble {
        background: var(--accent);
        color: white;
        border-bottom-right-radius: var(--radius-sm);
      }

      .message.assistant .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-bottom-left-radius: var(--radius-sm);
      }

      .message-time {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
        opacity: 0.8;
      }

      .message.user .message-time {
        text-align: right;
      }

      .message.assistant .message-time {
        text-align: left;
      }

      /* Citations */
      .citations {
        margin-top: 8px;
        font-size: 11px;
        color: var(--text-muted);
        border-top: 1px solid var(--border-color);
        padding-top: 8px;
      }

      .citation {
        display: inline-block;
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 4px;
        margin-bottom: 4px;
        font-family: monospace;
      }

      /* Input Form */
      .input-form {
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-primary);
        flex-shrink: 0;
      }

      .input-container {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .input-field {
        flex: 1;
        position: relative;
      }

      .input-field textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
        resize: none;
        outline: none;
        transition: border-color 0.2s ease;
        min-height: 44px;
        max-height: 120px;
        line-height: 1.4;
      }

      .input-field textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(2, 108, 189, 0.1);
      }

      .input-field textarea::placeholder {
        color: var(--text-muted);
      }

      .send-button {
        background: var(--accent);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        min-width: 80px;
      }

      .send-button:hover:not(:disabled) {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .send-button:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Footer */
      footer {
        padding: 12px 20px;
        text-align: center;
        font-size: 11px;
        color: var(--text-muted);
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
        flex-shrink: 0;
      }

      footer a {
        color: var(--accent);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      /* Loading States */
      .loading {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 13px;
      }

      .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar Styling */
      .chat-log::-webkit-scrollbar {
        width: 6px;
      }

      .chat-log::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }

      .chat-log::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
      }

      .chat-log::-webkit-scrollbar-thumb:hover {
        background: var(--border-hover);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
      }

      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 16px;
        margin-bottom: 8px;
        color: var(--text-secondary);
      }

      .empty-state p {
        font-size: 14px;
        line-height: 1.5;
      }

      /* Responsive Design */
      @media (max-width: 480px) {
        header,
        .suggested,
        .input-form,
        footer {
          padding-left: 16px;
          padding-right: 16px;
        }

        .chat-log {
          padding: 16px;
        }

        .message-bubble {
          max-width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="logo" id="logo">
        <span>AI</span>
      </div>
      <div class="header-content">
        <h1 id="title">AI Assistant</h1>
        <p id="subtitle">Ask me anything about our services and process.</p>
      </div>
    </header>

    <!-- Suggested Questions -->
    <div class="suggested">
      <h3>Quick Questions</h3>
      <div class="chips" id="suggested-chips">
        <!-- Suggested questions will be loaded here -->
      </div>
    </div>

    <!-- Chat Log -->
    <div class="chat-log" id="chat-log">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
          />
        </svg>
        <h3>Welcome!</h3>
        <p>
          Ask me anything or click one of the suggested questions above to get
          started.
        </p>
      </div>
    </div>

    <!-- Input Form -->
    <div class="input-form">
      <form id="chat-form">
        <div class="input-container">
          <div class="input-field">
            <textarea
              id="message-input"
              placeholder="Type your question here..."
              rows="1"
              maxlength="1000"
            ></textarea>
          </div>
          <button type="submit" class="send-button" id="send-button">
            Send
          </button>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <footer id="footer">© 2024 AI Assistant</footer>

    <script>
      // Configuration
      const API_BASE = window.location.origin;
      let isTyping = false;

      // DOM Elements
      const chatLog = document.getElementById("chat-log");
      const chatForm = document.getElementById("chat-form");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const suggestedChips = document.getElementById("suggested-chips");

      // Auto-resize textarea
      messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
      });

      // Handle form submission
      chatForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        await sendMessage();
      });

      // Handle Enter key (Shift+Enter for new line)
      messageInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Send message function
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isTyping) return;

        // Clear input
        messageInput.value = "";
        messageInput.style.height = "auto";

        // Add user message
        addMessage("user", message);

        // Show typing indicator
        showTypingIndicator();

        try {
          // Send to API
          const response = await fetch(`${API_BASE}/chat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              session_id: Date.now().toString(),
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Remove typing indicator
          hideTypingIndicator();

          // Add assistant response
          addMessage("assistant", data.answer, data.citations);
        } catch (error) {
          console.error("Error sending message:", error);
          hideTypingIndicator();
          addMessage(
            "assistant",
            "Sorry, I encountered an error. Please try again.",
            []
          );
        }
      }

      // Add message to chat
      function addMessage(role, content, citations = []) {
        // Remove empty state if it exists
        const emptyState = chatLog.querySelector(".empty-state");
        if (emptyState) {
          emptyState.remove();
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}`;

        const timestamp = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        let citationsHtml = "";
        if (citations && citations.length > 0) {
          citationsHtml = `
          <div class="citations">
            Sources: ${citations
              .map(
                (c) =>
                  `<span class="citation">[${c.index}] ${
                    c.source || "document"
                  }</span>`
              )
              .join(" ")}
          </div>
        `;
        }

        messageDiv.innerHTML = `
        <div class="message-bubble">${content}</div>
        <div class="message-time">${timestamp}</div>
        ${citationsHtml}
      `;

        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      // Show typing indicator
      function showTypingIndicator() {
        isTyping = true;
        sendButton.disabled = true;
        sendButton.textContent = "Sending...";

        const typingDiv = document.createElement("div");
        typingDiv.className = "message assistant";
        typingDiv.id = "typing-indicator";
        typingDiv.innerHTML = `
        <div class="message-bubble">
          <div class="loading">
            <div class="loading-spinner"></div>
            Thinking...
          </div>
        </div>
      `;

        chatLog.appendChild(typingDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      // Hide typing indicator
      function hideTypingIndicator() {
        isTyping = false;
        sendButton.disabled = false;
        sendButton.textContent = "Send";

        const typingIndicator = document.getElementById("typing-indicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Load settings and suggested questions
      async function loadSettings() {
        try {
          const [settingsResponse, suggestedResponse] = await Promise.all([
            fetch(`${API_BASE}/settings`),
            fetch(`${API_BASE}/suggested`),
          ]);

          if (settingsResponse.ok) {
            const settings = await settingsResponse.json();

            // Update UI with settings
            document.getElementById("title").textContent =
              settings.title || "AI Assistant";
            document.getElementById("subtitle").textContent =
              settings.subtitle || "";
            document.getElementById("footer").textContent =
              settings.footer || "© 2024 AI Assistant";

            // Update accent color
            if (settings.accent) {
              document.documentElement.style.setProperty(
                "--accent",
                settings.accent
              );
              document.documentElement.style.setProperty(
                "--accent-hover",
                adjustBrightness(settings.accent, -20)
              );
            }

            // Update logo
            const logoElement = document.getElementById("logo");
            if (settings.logo) {
              logoElement.innerHTML = `<img src="${settings.logo}" alt="Logo" />`;
            } else {
              logoElement.innerHTML = "<span>AI</span>";
            }
          }

          if (suggestedResponse.ok) {
            const suggested = await suggestedResponse.json();
            loadSuggestedQuestions(suggested.suggested || []);
          }
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      // Load suggested questions
      function loadSuggestedQuestions(questions) {
        suggestedChips.innerHTML = "";

        questions.forEach((question) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.textContent = question;
          chip.addEventListener("click", () => {
            messageInput.value = question;
            messageInput.focus();
          });
          suggestedChips.appendChild(chip);
        });
      }

      // Utility function to adjust color brightness
      function adjustBrightness(hex, percent) {
        const num = parseInt(hex.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = ((num >> 8) & 0x00ff) + amt;
        const B = (num & 0x0000ff) + amt;
        return (
          "#" +
          (
            0x1000000 +
            (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
            (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
            (B < 255 ? (B < 1 ? 0 : B) : 255)
          )
            .toString(16)
            .slice(1)
        );
      }

      // Listen for messages from parent window
      window.addEventListener("message", function (event) {
        if (event.data.type === "INIT") {
          console.log("Chat interface initialized");
        }
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadSettings();
        messageInput.focus();
      });
    </script>
  </body>
</html>
